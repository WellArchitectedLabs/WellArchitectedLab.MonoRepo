apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: tempo
  namespace: argocd
  labels:
    workload: operations
    isGrafana: "true"
  annotations:
    argocd.argoproj.io/sync-wave: "11" # We need tempo to run before grafana is started
spec:
  project: default
  source:
    repoURL: https://grafana.github.io/helm-charts
    chart: tempo
    targetRevision: 1.7.1
    helm:
      values: |
        tempo:
          # retention is the period of time
          # for traces persistence
          retention: 24h

        persistence:
          enabled: true
          size: 5Gi

        resources:
          requests:
            memory: "100Mi"
            cpu: "50m"

        # Define an OTLP receiver
        # For receiving open telemetry from otlp collector
        receivers:
          otlp:
            protocols:
              http:
                enabled: true
              grpc:
                enabled: true

        # Activate metrics generator
        # Metrics generator is necessary for plugging Tempo to prometheus's metrics
        # This will allow us to monitor Tempo (which is basically a traces system) via dedicated metrics that are pushed into prometheus db
        metricsGenerator:
          enabled: true

          remoteWrite:
            - url: http://prometheus-server-kube-pro-prometheus.monitoring.svc.cluster.local:9090/api/v1/write

          processors:

            # We also include the service_graph processor which correlates grafana metrics with their related traces
            # That is necessary for grafana drill down functionality to traces from prometheus metrics
            - service-graphs
            # Processor that will push metrics that are related to Tempo traces (or what we call spans in Tempo terminology) 
            # The most common metric is: tempo_spanmetrics_latency_bucket
            - span-metrics

          config:
            registry:
              collection_interval: 15s

          storage:
            path: /var/tempo/metrics

          serviceMonitor:
            enabled: true

  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
