apiVersion: batch/v1
kind: CronJob
metadata:
  name: grafana-dashboard-backup
  namespace: monitoring
spec:
  schedule: "0 2 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          volumes:
            - name: backup-volume
              emptyDir: {}
          containers:
            # Container 1: Grafana CLI
            - name: grafana-backup
              image: grafana/grafana:latest
              volumeMounts:
                - mountPath: /backups
                  name: backup-volume
              env:
                - name: GRAFANA_URL
                  value: "http://grafana.monitoring.svc.cluster.local"
                - name: GRAFANA_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: dev-grafana-secrets
                      key: GRAFANA_TOKEN
              args:
                - /bin/sh
                - -c
                - |
                  grafana-cli dashboards backup --output /backups/grafana-dashboards.json

            # Container 2: GitHub CLI
            - name: github-pr
              image: bitnami/git:latest
              volumeMounts:
                - mountPath: /backups
                  name: backup-volume
              env:
                - name: GITHUB_PAT
                  valueFrom:
                    secretKeyRef:
                      name: dev-github-secrets
                      key: GITHUB_PAT
                - name: GIT_REPO
                  value: "WellArchitectedLabs/WellArchitectedLab.MonoRepo"
                - name: TARGET_BRANCH
                  value: "develop"
                - name: SOURCE_BRANCH
                  value: "grafana-dashboard-backup"
              args:
                - /bin/sh
                - -c
                - |
                  set -euo pipefail

                  # Install gh CLI (static binary, no gpg, no apt)
                  GH_VERSION=2.35.0
                  curl -sSL https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_amd64.tar.gz \
                    | tar -xz
                  mv gh_${GH_VERSION}_linux_amd64/bin/gh /usr/local/bin/gh

                  # Authenticate gh
                  echo "${GITHUB_PAT}" | gh auth login --with-token

                  cd /backups
                  git clone https://github.com/${GIT_REPO}.git repo
                  cd repo
                  git checkout -B ${SOURCE_BRANCH}

                  cp /backups/grafana-dashboards.json grafana-dashboards.json

                  git config user.name "grafana-backup-bot"
                  git config user.email "grafana-backup@org.local"
                  git add grafana-dashboards.json
                  git commit -m "Automated Grafana dashboards backup" || exit 0

                  git push -f https://${GITHUB_PAT}@github.com/${GIT_REPO}.git ${SOURCE_BRANCH}

                  # Create or update PR
                  gh pr create \
                    --repo ${GIT_REPO} \
                    --head ${SOURCE_BRANCH} \
                    --base ${TARGET_BRANCH} \
                    --title "Automated Grafana dashboards backup" \
                    --body "Backup JSON updated." \
                  || gh pr edit ${SOURCE_BRANCH} \
                    --title "Automated Grafana dashboards backup" \
                    --body "Backup JSON updated."
