apiVersion: v1
kind: ConfigMap
metadata:
  name: master-data-initdb-configmap
  namespace: backend
data:
  01-create-app-user.sh: |
    #!/bin/bash
    set -e
    
    echo "=== Starting application user creation ==="
    echo "Database: ${POSTGRES_DATABASE}"
    echo "App User: ${DB_APP_USER}"
    
    # Init scripts run during PostgreSQL initialization
    # At this point, PostgreSQL is running in "trust" authentication mode
    # So we don't need to provide a password
    
    # Simply connect without password - it will work during initialization
    psql -U postgres -d "${POSTGRES_DATABASE}" -v ON_ERROR_STOP=1 <<-EOSQL
        -- Create application user (if not exists)
        DO \$\$
        BEGIN
          IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '${DB_APP_USER}') THEN
            CREATE ROLE "${DB_APP_USER}" LOGIN PASSWORD '${DB_APP_PASSWORD}';
            RAISE NOTICE 'User ${DB_APP_USER} created successfully';
          ELSE
            RAISE NOTICE 'User ${DB_APP_USER} already exists';
            -- Update password in case it changed
            EXECUTE format('ALTER ROLE %I WITH PASSWORD %L', '${DB_APP_USER}', '${DB_APP_PASSWORD}');
            RAISE NOTICE 'Password updated for user ${DB_APP_USER}';
          END IF;
        END
        \$\$;

        -- Grant connection to the database
        GRANT CONNECT ON DATABASE ${POSTGRES_DATABASE} TO "${DB_APP_USER}";
        
        -- Grant usage and create on public schema
        GRANT USAGE, CREATE ON SCHEMA public TO "${DB_APP_USER}";
        
        -- Grant permissions on existing tables
        GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO "${DB_APP_USER}";
        
        -- Grant permissions on existing sequences (for auto-increment columns)
        GRANT USAGE, SELECT, UPDATE ON ALL SEQUENCES IN SCHEMA public TO "${DB_APP_USER}";
        
        -- Set default privileges for future objects created by postgres user
        ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA public
          GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO "${DB_APP_USER}";
        
        ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA public
          GRANT USAGE, SELECT, UPDATE ON SEQUENCES TO "${DB_APP_USER}";
        
        -- Verify user was created
        SELECT 'Created user: ' || rolname || ', Can login: ' || rolcanlogin 
        FROM pg_roles 
        WHERE rolname = '${DB_APP_USER}';
    EOSQL
    
    echo "=== Application user '${DB_APP_USER}' setup completed successfully ==="